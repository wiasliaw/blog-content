---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { formatDate } from '../utils/date';

const posts = await getCollection('posts', ({ data }) => !data.draft);

// Sort posts by date (newest first)
const sortedPosts = posts.sort(
  (a, b) => b.data.created.valueOf() - a.data.created.valueOf()
);

// Group posts by year and month
type PostEntry = typeof posts[0];
type PostsByMonth = Map<number, PostEntry[]>;
type PostsByYear = Map<number, PostsByMonth>;

const postsByYear: PostsByYear = new Map();

sortedPosts.forEach((post) => {
  const year = post.data.created.getFullYear();
  const month = post.data.created.getMonth() + 1;

  if (!postsByYear.has(year)) {
    postsByYear.set(year, new Map());
  }
  const yearMap = postsByYear.get(year)!;

  if (!yearMap.has(month)) {
    yearMap.set(month, []);
  }
  yearMap.get(month)!.push(post);
});

// Convert to sorted arrays for rendering
const years = [...postsByYear.entries()].sort((a, b) => b[0] - a[0]);

const totalPosts = posts.length;

// Helper to get month name in Traditional Chinese
function getMonthName(month: number): string {
  const monthNames = [
    '一月', '二月', '三月', '四月', '五月', '六月',
    '七月', '八月', '九月', '十月', '十一月', '十二月'
  ];
  return monthNames[month - 1];
}
---

<BaseLayout title="Archive" description="All posts by date">
  <div class="prose mx-auto">
    <header class="text-center mb-8 sm:mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold mb-4">Archive</h1>
      <p class="text-muted text-sm sm:text-base">
        {totalPosts} {totalPosts === 1 ? 'post' : 'posts'} total
      </p>
    </header>

    <div class="timeline">
      {years.map(([year, months]) => (
        <section class="year-section mb-8 sm:mb-12">
          <h2 class="text-xl sm:text-2xl font-bold sticky top-16 sm:top-20 bg-background/95 backdrop-blur-sm py-2 sm:py-3 z-10 border-b border-border mb-4 sm:mb-6">
            {year}
          </h2>

          {[...months.entries()]
            .sort((a, b) => b[0] - a[0])
            .map(([month, monthPosts]) => (
              <div class="month-section ml-4 mb-8">
                <h3 class="text-lg font-medium text-muted mb-4">
                  {getMonthName(month)}
                </h3>

                <ul class="list-none pl-0 ml-4 border-l-2 border-border">
                  {monthPosts.map((post) => (
                    <li class="relative pl-6 pb-6 last:pb-0">
                      <span class="absolute left-[-5px] top-2 w-2 h-2 bg-primary rounded-full"></span>
                      <time class="text-sm text-muted block mb-1">
                        {formatDate(post.data.created, 'MM-DD')}
                      </time>
                      <a
                        href={`/posts/${post.id}`}
                        class="text-foreground font-medium no-underline hover:text-primary transition-colors"
                      >
                        {post.data.title}
                      </a>
                      {post.data.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2 mt-2">
                          {post.data.tags.slice(0, 3).map((tag) => (
                            <a
                              href={`/tags/${tag}`}
                              class="text-xs text-muted bg-secondary px-2 py-0.5 rounded no-underline hover:text-primary"
                            >
                              #{tag}
                            </a>
                          ))}
                        </div>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            ))}
        </section>
      ))}
    </div>

    {totalPosts === 0 && (
      <p class="text-center text-muted">No posts found.</p>
    )}
  </div>
</BaseLayout>
