---
import BaseLayout from '../layouts/BaseLayout.astro';
import { buildGraphData } from '../utils/graph';

const graphData = await buildGraphData();
---

<BaseLayout title="Graph View" description="Interactive graph visualization of all notes">
  <div class="max-w-[--width-page] mx-auto">
    <header class="text-center mb-8">
      <h1 class="mt-0">Graph View</h1>
      <p class="text-muted">Interactive visualization of connections between notes. Click on a node to navigate to that post.</p>
    </header>

    <div 
      class="full-graph-container w-full h-[600px] bg-secondary border border-border rounded-xl overflow-hidden" 
      id="full-graph"
      data-nodes={JSON.stringify(graphData.nodes)}
      data-links={JSON.stringify(graphData.links)}
    >
    </div>

    {graphData.nodes.length === 0 && (
      <p class="text-center text-muted p-12">No posts found. Add markdown files to <code>src/content/posts/</code> to see the graph.</p>
    )}
  </div>
</BaseLayout>

<style>
  .full-graph-container :global(svg) {
    width: 100%;
    height: 100%;
  }

  .full-graph-container :global(.node) {
    cursor: pointer;
  }

  .full-graph-container :global(.node circle) {
    transition: r 0.2s ease;
  }

  .full-graph-container :global(.node:hover circle) {
    r: 12;
  }

  .full-graph-container :global(.node text) {
    font-size: 12px;
    fill: var(--color-graph-text);
    pointer-events: none;
  }

  .full-graph-container :global(.link) {
    stroke: var(--color-graph-link);
    stroke-opacity: 0.6;
  }
</style>

<script>
  import * as d3 from 'd3';

  interface GraphNode extends d3.SimulationNodeDatum {
    id: string;
    title: string;
    tags: string[];
  }

  interface GraphLink extends d3.SimulationLinkDatum<GraphNode> {
    source: string | GraphNode;
    target: string | GraphNode;
  }

  function initFullGraph() {
    const container = document.getElementById('full-graph');
    if (!container) return;

    const nodesData: GraphNode[] = JSON.parse(container.dataset.nodes || '[]');
    const linksData: GraphLink[] = JSON.parse(container.dataset.links || '[]');

    if (nodesData.length === 0) return;

    const width = container.clientWidth;
    const height = container.clientHeight;

    // Clear existing content
    container.innerHTML = '';

    const svg = d3.select(container)
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .attr('viewBox', [0, 0, width, height]);

    // Add zoom behavior
    const g = svg.append('g');
    
    svg.call(d3.zoom<SVGSVGElement, unknown>()
      .extent([[0, 0], [width, height]])
      .scaleExtent([0.5, 4])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
      }) as any);

    // Create simulation
    const simulation = d3.forceSimulation<GraphNode>(nodesData)
      .force('link', d3.forceLink<GraphNode, GraphLink>(linksData)
        .id(d => d.id)
        .distance(100))
      .force('charge', d3.forceManyBody().strength(-300))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(40));

    // Create links
    const link = g.append('g')
      .attr('class', 'links')
      .selectAll('line')
      .data(linksData)
      .join('line')
      .attr('class', 'link')
      .attr('stroke-width', 1.5);

    // Create nodes
    const node = g.append('g')
      .attr('class', 'nodes')
      .selectAll('g')
      .data(nodesData)
      .join('g')
      .attr('class', 'node')
      .call(d3.drag<SVGGElement, GraphNode>()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended) as any);

    // Add circles to nodes
    node.append('circle')
      .attr('r', 8)
      .attr('fill', 'var(--color-graph-node)');

    // Add labels to nodes
    node.append('text')
      .text(d => d.title)
      .attr('x', 12)
      .attr('y', 4);

    // Add click handler for navigation
    node.on('click', (event, d) => {
      window.location.href = `/posts/${d.id}`;
    });

    // Add title for hover
    node.append('title')
      .text(d => d.title);

    // Update positions on tick
    simulation.on('tick', () => {
      link
        .attr('x1', d => (d.source as GraphNode).x || 0)
        .attr('y1', d => (d.source as GraphNode).y || 0)
        .attr('x2', d => (d.target as GraphNode).x || 0)
        .attr('y2', d => (d.target as GraphNode).y || 0);

      node.attr('transform', d => `translate(${d.x || 0},${d.y || 0})`);
    });

    function dragstarted(event: d3.D3DragEvent<SVGGElement, GraphNode, GraphNode>) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      event.subject.fx = event.subject.x;
      event.subject.fy = event.subject.y;
    }

    function dragged(event: d3.D3DragEvent<SVGGElement, GraphNode, GraphNode>) {
      event.subject.fx = event.x;
      event.subject.fy = event.y;
    }

    function dragended(event: d3.D3DragEvent<SVGGElement, GraphNode, GraphNode>) {
      if (!event.active) simulation.alphaTarget(0);
      event.subject.fx = null;
      event.subject.fy = null;
    }
  }

  // Run on initial load
  initFullGraph();

  // Re-run after Astro page transitions
  document.addEventListener('astro:after-swap', initFullGraph);

  // Handle resize
  let resizeTimeout: ReturnType<typeof setTimeout>;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(initFullGraph, 250);
  });
</script>
