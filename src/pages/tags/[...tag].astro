---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  
  // Get all unique tags
  const tags = [...new Set(posts.flatMap((post) => post.data.tags))];
  
  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tags.includes(tag))
        .sort((a, b) => b.data.created.valueOf() - a.data.created.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<BaseLayout title={`Tag: ${tag}`} description={`Posts tagged with "${tag}"`}>
  <div class="prose mx-auto">
    <Breadcrumb items={[
      { label: 'Home', href: '/' },
      { label: 'Tags', href: '/tags' },
      { label: `#${tag}` }
    ]} />

    <header class="mb-8">
      <h1 class="text-primary">#{tag}</h1>
      <p class="text-muted">{posts.length} post{posts.length !== 1 ? 's' : ''}</p>
    </header>

    <div class="flex flex-col gap-4 not-prose">
      {posts.map((post) => (
        <PostCard
          title={post.data.title}
          description={post.data.description}
          created={post.data.created}
          showCreated={post.data.showCreated}
          dateFormat={post.data.dateFormat}
          tags={post.data.tags}
          slug={post.id}
        />
      ))}
    </div>
  </div>
</BaseLayout>
