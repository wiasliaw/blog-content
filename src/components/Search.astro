---
// Pagefind search component
---

<div class="search-container">
  <button id="search-btn" type="button" class="search-trigger" aria-label="Search">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.3-4.3"></path>
    </svg>
    <span class="search-text">Search</span>
    <kbd class="search-kbd">Ctrl K</kbd>
  </button>
</div>

<style>
  .search-container {
    display: flex;
    align-items: center;
  }

  .search-trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-background);
    box-shadow: var(--neu-shadow-light-sm);
    border: none;
    border-radius: 0.5rem;
    color: var(--color-muted);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .search-trigger:hover {
    box-shadow: var(--neu-shadow-light);
    color: var(--color-foreground);
  }

  .search-trigger:active {
    box-shadow: var(--neu-shadow-light-pressed);
  }

  .search-text {
    display: none;
  }

  @media (min-width: 640px) {
    .search-text {
      display: inline;
    }
  }

  .search-kbd {
    display: none;
    padding: 0.125rem 0.375rem;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    font-family: inherit;
    font-size: 0.75rem;
    color: var(--color-muted);
  }

  @media (min-width: 768px) {
    .search-kbd {
      display: inline;
    }
  }

  :global(.search-modal) {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: none;
    overflow-y: auto;
  }

  :global(.search-modal[aria-hidden="false"]) {
    display: flex;
    flex-direction: column;
  }

  :global(.search-backdrop) {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  :global(.search-dialog-wrapper) {
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: center;
    padding: 10vh 1rem 2rem;
    min-height: 100%;
  }

  :global(.search-dialog) {
    width: 100%;
    max-width: 640px;
    height: fit-content;
    padding: 1rem;
    background: var(--color-background);
    border: none;
    border-radius: 0.75rem;
    box-shadow: var(--neu-shadow-light);
  }

  /* Pagefind UI overrides */
  :global(.pagefind-ui) {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: var(--color-primary);
    --pagefind-ui-text: var(--color-foreground);
    --pagefind-ui-background: var(--color-background);
    --pagefind-ui-border: var(--color-border);
    --pagefind-ui-tag: var(--color-secondary);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 0.5rem;
    --pagefind-ui-font: inherit;
  }

  :global(.pagefind-ui__search-input) {
    font-size: 1rem !important;
  }

  :global(.pagefind-ui__result-link) {
    color: var(--color-primary) !important;
  }
</style>

<script is:inline>
  (function() {
    let pagefindUI = null;
    let pagefindLoaded = false;
    let pagefindLoading = false;
    let keyboardInitialized = false;

    function loadPagefind() {
      return new Promise((resolve, reject) => {
        if (pagefindLoaded) {
          resolve();
          return;
        }

        if (pagefindLoading) {
          const checkLoaded = setInterval(() => {
            if (pagefindLoaded) {
              clearInterval(checkLoaded);
              resolve();
            }
          }, 50);
          return;
        }

        pagefindLoading = true;

        try {
          if (!document.querySelector('link[href="/pagefind/pagefind-ui.css"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/pagefind/pagefind-ui.css';
            document.head.appendChild(link);
          }

          if (!document.querySelector('script[src="/pagefind/pagefind-ui.js"]')) {
            const script = document.createElement('script');
            script.src = '/pagefind/pagefind-ui.js';
            script.onload = () => {
              pagefindLoaded = true;
              pagefindLoading = false;
              resolve();
            };
            script.onerror = (err) => {
              pagefindLoading = false;
              reject(err);
            };
            document.head.appendChild(script);
          } else {
            const checkUI = setInterval(() => {
              if (window.PagefindUI) {
                clearInterval(checkUI);
                pagefindLoaded = true;
                pagefindLoading = false;
                resolve();
              }
            }, 50);
          }
        } catch (e) {
          pagefindLoading = false;
          console.error('Failed to load Pagefind:', e);
          reject(e);
        }
      });
    }

    function createModal() {
      if (document.getElementById('search-modal')) return;

      const modal = document.createElement('div');
      modal.id = 'search-modal';
      modal.className = 'search-modal';
      modal.setAttribute('aria-hidden', 'true');
      modal.innerHTML = `
        <div class="search-backdrop" aria-hidden="true"></div>
        <div class="search-dialog-wrapper">
          <div class="search-dialog" role="dialog" aria-modal="true" aria-label="Search">
            <div id="pagefind-container"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function initSearch() {
      const btn = document.getElementById('search-btn');
      if (!btn) return;

      // Prevent duplicate initialization
      if (btn.dataset.initialized) return;
      btn.dataset.initialized = 'true';

      // Create modal on first button interaction
      createModal();

      const modal = document.getElementById('search-modal');
      const backdrop = modal?.querySelector('.search-backdrop');
      const dialogWrapper = modal?.querySelector('.search-dialog-wrapper');
      const container = document.getElementById('pagefind-container');

      if (!modal || !container) return;

      async function openModal() {
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        try {
          await loadPagefind();

          if (!pagefindUI && window.PagefindUI) {
            pagefindUI = new window.PagefindUI({
              element: container,
              showSubResults: true,
              showImages: false,
            });
          }

          setTimeout(() => {
            const input = container.querySelector('input');
            input?.focus();
          }, 100);
        } catch (e) {
          console.error('Failed to initialize Pagefind:', e);
        }
      }

      function closeModal() {
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      btn.addEventListener('click', openModal);
      backdrop?.addEventListener('click', closeModal);

      dialogWrapper?.addEventListener('click', (e) => {
        if (e.target === dialogWrapper) {
          closeModal();
        }
      });

      // Only add keyboard listener once
      if (!keyboardInitialized) {
        keyboardInitialized = true;
        document.addEventListener('keydown', (e) => {
          const currentModal = document.getElementById('search-modal');

          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            // Ensure modal exists
            createModal();
            const m = document.getElementById('search-modal');
            if (!m) return;

            if (m.getAttribute('aria-hidden') === 'true') {
              m.setAttribute('aria-hidden', 'false');
              document.body.style.overflow = 'hidden';

              loadPagefind().then(() => {
                const cont = document.getElementById('pagefind-container');
                if (!pagefindUI && window.PagefindUI && cont) {
                  pagefindUI = new window.PagefindUI({
                    element: cont,
                    showSubResults: true,
                    showImages: false,
                  });
                }
                setTimeout(() => {
                  const input = cont?.querySelector('input');
                  input?.focus();
                }, 100);
              });
            } else {
              m.setAttribute('aria-hidden', 'true');
              document.body.style.overflow = '';
            }
          }

          if (e.key === 'Escape' && currentModal?.getAttribute('aria-hidden') === 'false') {
            currentModal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
          }
        });
      }
    }

    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSearch);
    } else {
      initSearch();
    }

    // Re-initialize after view transitions
    document.addEventListener('astro:after-swap', () => {
      const btn = document.getElementById('search-btn');
      if (btn) btn.dataset.initialized = '';
      // Modal persists in body, just reinit button
      initSearch();
    });
  })();
</script>
